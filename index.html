<!DOCTYPE html>
<html>
<head>
  <title>Study Buddy - Notes</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    label, select, input, button { display: block; margin: 10px 0; }
    .note { border: 1px solid #ccc; margin: 5px 0; padding: 5px; }
    .subject { font-weight: bold; margin-top: 10px; }
    .unit { font-style: italic; margin-left: 10px; }
  </style>
</head>
<body>
  <h2>Upload a Note</h2>

  <label>Subject:</label>
  <select id="noteSubject" required>
    <option value="">Select subject</option>
    <option>Math</option>
    <option>Science</option>
    <option>History</option>
    <option>English</option>
  </select>

  <label>Unit:</label>
  <select id="noteUnit" required>
    <option value="">Select unit</option>
    <option>Unit 1</option>
    <option>Unit 2</option>
    <option>Unit 3</option>
  </select>

  <label>Photo of Note:</label>
  <input type="file" id="notePhoto" accept="image/*" capture="environment">

  <button onclick="uploadNote()">Upload Note</button>

  <h2>Notes Library</h2>
  <div id="notesDisplay">No notes yet.</div>

<script>
const WORKER_URL = "study-helper.sienawlewis.workers.dev"; // Replace with your Cloudflare Worker URL

let notes = JSON.parse(localStorage.getItem("notes") || "[]");

function renderNotes() {
  const container = document.getElementById("notesDisplay");
  container.innerHTML = "";
  if(notes.length === 0) { container.textContent = "No notes yet."; return; }

  const grouped = {};
  notes.forEach(n => {
    if(!grouped[n.subject]) grouped[n.subject] = {};
    if(!grouped[n.subject][n.unit]) grouped[n.subject][n.unit] = [];
    grouped[n.subject][n.unit].push(n);
  });

  for(const subject in grouped) {
    const subjDiv = document.createElement("div");
    subjDiv.className = "subject";
    subjDiv.textContent = subject;
    container.appendChild(subjDiv);

    for(const unit in grouped[subject]) {
      const unitDiv = document.createElement("div");
      unitDiv.className = "unit";
      unitDiv.textContent = unit;
      container.appendChild(unitDiv);

      grouped[subject][unit].forEach(note => {
        const noteDiv = document.createElement("div");
        noteDiv.className = "note";
        noteDiv.innerHTML = `<strong>AI Summary:</strong><br>${note.text}<br>
                             <img src="${note.photo}" style="max-width:100%">`;
        container.appendChild(noteDiv);
      });
    }
  }
}

function uploadNote() {
  const subject = document.getElementById("noteSubject").value;
  const unit = document.getElementById("noteUnit").value;
  const fileInput = document.getElementById("notePhoto");

  if(!subject || !unit || !fileInput.files[0]) {
    alert("Please select subject, unit, and photo.");
    return;
  }

  const file = fileInput.files[0];
  const reader = new FileReader();
  reader.onload = async () => {
    const base64 = reader.result.split(",")[1];

    try {
      const response = await fetch(WORKER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "gpt-4.1-mini",
          input: [
            { role: "user", content: [
                { type: "input_text", text: "Read these notes and summarize for study." },
                { type: "input_image", image_base64: base64 }
              ] }
          ]
        })
      });

      const data = await response.json();
      const aiText = data.output_text || "No response from AI.";

      notes.push({ subject, unit, photo: reader.result, text: aiText });
      localStorage.setItem("notes", JSON.stringify(notes));
      renderNotes();

      // Reset form
      fileInput.value = "";
      document.getElementById("noteSubject").value = "";
      document.getElementById("noteUnit").value = "";

    } catch(err) {
      alert("Error uploading note: " + err.message);
    }
  };

  reader.readAsDataURL(file);
}

// Initial render
renderNotes();
</script>
</body>
</html>

